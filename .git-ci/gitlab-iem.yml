# gitlab-ci configuration for the IEM Plugin Suite

variables:
  PROJECTS: AllRADecoder BinauralDecoder DirectionalCompressor DirectivityShaper DualDelay EnergyVisualizer FdnReverb MatrixMultiplicator MultiEncoder OmniCompressor ProbeDecoder RoomEncoder SimpleDecoder StereoEncoder ToolBox
  CONFIG: Release
  JUCEVERSION: 5.3.2

### configuration templates (to be used for snapshot and release builds)
.build:linux: &build_linux
  image: debian:buster
  stage: build
  tags:
    - docker
  only:
    - master
    - develop
  variables:
    PKGLIBS: jack fftw3f
  script:
    - apt update -y
    - apt dist-upgrade -y
    - apt-get install -y --no-install-recommends xvfb xauth curl unzip build-essential ca-certificates
    - apt-get install -y --no-install-recommends libwebkit2gtk-4.0-dev libasound2-dev libfreetype6-dev libcurl4-gnutls-dev libgl1-mesa-dev libx11-dev libxext-dev libxinerama-dev libxrandr-dev libgtk-3-dev
    - apt-get install -y --no-install-recommends libjack-dev libfftw3-dev
    - .git-ci/getjuce.sh "${JUCEVERSION}-linux" ~/JUCE
    - xvfb-run -a make -k V=1 CONFIG=${CONFIG} CPPFLAGS=-DJUCE_JACK=1 CFLAGS="$(pkg-config --cflags ${PKGLIBS})" LDFLAGS="$(pkg-config --libs ${PKGLIBS})" PROJUCER=~/JUCE/Projucer

    - mkdir IEM
    - cp */Builds/*/build/*.so IEM/

.build:osx: &build_osx
  tags:
    - osx
  stage: build
  only:
    - master
    - develop
  script:
    - brew install fftw
    - .git-ci/getjuce.sh "${JUCEVERSION}-osx" ~/JUCE
    - make -k CONFIG=$CONFIG PROJUCER="~/JUCE/Projucer.app/Contents/MacOS/Projucer"

    - mkdir IEM
    - cp -R -H */Builds/*/build/${CONFIG}/*.vst IEM/

.build:windows: &build_windows
  tags:
    - windows
  variables:
    IEMCI_CONFIGURATIONS: vs2017
  stage: build
  only:
    - master
    - develop
  script:
    - test -f .myenv && . .myenv
    - test -f .myenv && cat .myenv
    - echo "BITS...$BITS"
    - .git-ci/getjuce.sh "${JUCEVERSION}-windows" /c/JUCE
    - .git-ci/fftw4win.sh $BITS
# run the actual build
    - make system CONFIG=$CONFIG BITS=$BITS PROJUCER="/c/JUCE/Projucer.exe"
    - make -k CONFIG=$CONFIG BITS=$BITS PROJUCER="/c/JUCE/Projucer.exe"

    - mkdir IEM
    - cp */Builds/*/build/*/*.dll IEM/

###################################################
# expand the templates to real jobs
#
# development snapshots
linux_snapshot:
  <<: *build_linux

osx_snapshot:
  <<: *build_osx

windows32_snapshot:
  before_script:
    - echo "BITS=32" > .myenv
  <<: *build_windows

windows64_snapshot:
  before_script:
    - echo "BITS=64" > .myenv
  <<: *build_windows

after_script:
  - test -d IEM && find IEM -type f -exec file {} +
