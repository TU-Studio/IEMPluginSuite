# gitlab-ci configuration for the IEM Plugin Suite

variables:
  PROJECTS: AllRADecoder BinauralDecoder DirectionalCompressor DirectivityShaper DualDelay EnergyVisualizer FdnReverb MatrixMultiplicator MultiEncoder OmniCompressor ProbeDecoder RoomEncoder SimpleDecoder StereoEncoder ToolBox
  CONFIG: Release
  PKGLIBS: jack flac vorbis vorbisenc vorbisfile ogg libjpeg libpng zlib fftw3f

debian_buster:
  image: debian:buster
  stage: build
  tags:
    - docker
  only:
    - master
    - develop
  script:
# we need deb-src to be able to install the build-deps for 'iem-plugin-suite'
    - sed -e 's|^deb|deb-src|' /etc/apt/sources.list > /etc/apt/sources.list.d/deb-src.list
    - apt update -y
    - apt dist-upgrade -y
    - apt-get build-dep -y --no-install-recommends iem-plugin-suite
    - apt-get install -y --no-install-recommends libfftw3-dev
    - xvfb-run -a make -k V=1 CONFIG=$CONFIG CPPFLAGS=-DJUCE_JACK=1 CFLAGS="$(pkg-config --cflags $PKGLIBS)" LDFLAGS="$(pkg-config --libs $PKGLIBS)"

osx:
  tags:
    - osx
  stage: build
  only:
    - master
    - develop
  script:
    - brew install fftw
    - curl -o juce.zip https://d30pueezughrda.cloudfront.net/juce/juce-5.3.1-osx.zip
    - mkdir -p ~/JUCE
    - unzip -q juce.zip -d ~/JUCE
    - mv ~/JUCE/JUCE/* ~/JUCE/ || true
    - make -k CONFIG=$CONFIG PROJUCER="~/JUCE/Projucer.app/Contents/MacOS/Projucer"

windows:
  tags:
    - windows
  stage: build
  only:
    - master
    - develop
  script:
    - . ci-setenv vs2017
    - curl -o juce.zip https://d30pueezughrda.cloudfront.net/juce/juce-5.3.1-windows.zip
    - mkdir -p /c/JUCE
    - unzip -q juce.zip -d /c/JUCE
    - mv /c/JUCE/JUCE/* /c/JUCE/ || true
    - make -k CONFIG=$CONFIG PROJUCER="/c/JUCE/Projucer.exe"
